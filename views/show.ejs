<%- include("partials/header") %>

<div class="container pt-5 mt-5">
    <% messages.forEach(function(message){ %>
        <% if (typeof message === "object" && message.length) { %>
            <p class="fade-out-items text-secondary mb-4 open-sans-font"><%= message %></p>
        <% } %>
    <% }) %>

    <div class="row">
        <div class="col-md-8 col-lg-9">
            <div class="card-deck">
                <div class="card">
                    <a href="/index/show/<%= post._id %>"><img class="card-img-top" src="<%= post.image %>" alt="<%= post.title %>"></a>
                    <div class="card-body">
                        <h5 class="card-title"><%= post.title %></h5>
                        <p class="card-text"><%= post.body %> </p>
                        <div>
                            <a class= "btn btn-outline-success" href="<%= post.url %>">More info</a>
                            <% if(user && (user.username === post.author[0].username)){ %>
                                <a class="btn btn-outline-danger mx-1" href="/index/show/<%= post._id %>/edit">Edit</a>
                                <a class="btn btn-outline-danger" href="/index/show/<%= post._id %>/delete">Delete</a>
                            <% }; %>
                        </div>
                    </div>
                    <div class="card-footer">
                        <small class="text-muted open-sans-font"> Created by <strong class="text-success">
                            <% if(user && (user.username === post.author[0].username)){ %> <span>you</span>
                            <% } else { %> <%= post.author[0].username %> <% } %>
                            </strong> on <%= post.date.toLocaleDateString() %> 
                        </small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 col-lg-3 d-none d-md-block">
            <div class="row">
                <div id="openweathermap-widget-12" class="ml-2"></div>
                    <script>window.myWidgetParam ? window.myWidgetParam : window.myWidgetParam = [];  window.myWidgetParam.push({id: 12,cityid: "6173331",appid: "<%= WEATHERAPI %>",units: "metric",containerid: "openweathermap-widget-12",  });  (function() {var script = document.createElement("script");script.async = true;script.charset = "utf-8";script.src = "//openweathermap.org/themes/openweathermap/assets/vendor/owm/js/weather-widget-generator.js";var s = document.getElementsByTagName('script')[0];s.parentNode.insertBefore(script, s);  })();</script>
            </div>
            <div id="map" class="mt-5"></div>
                <script>
                    mapboxgl.accessToken = "<%= MAP %>";
                    const map = new mapboxgl.Map({
                        center: ["<%= post.location[0] %>", "<%= post.location[1] %>" ],
                        zoom: 14,
                        container: "map",
                        style: "mapbox://styles/mapbox/navigation-preview-day-v4"
                    });
                </script>
        </div>
    </div>
    <div class="row mt-3">
        <div class="col-md-8 col-lg-9">
            <div class="comment-wrapper">
                <div class="panel panel-info">
                    <div class="panel-body">
                        <% if(user){ %>
                            <form action="/index/show/<%= post._id %>" method="POST">
                                <textarea class="form-control" placeholder=" Write a comment..." rows="4" name="text" maxlength="1000" required></textarea>
                                <br>
                                <button type="submit" class="btn btn-secondary float-right">Post Comment</button>
                            </form>
                        <% }else{ %>
                            <a class="btn btn-secondary ml-3" href="/login">Log in to leave a comment</a>
                        <% } %>
                        <div class="clearfix"></div>
                        <hr>
                        <ul class="media-list">
                            <li class="media">
                                <div class="media-body">
                                    <% post.comments.forEach(function(comment){ %>
                                        <span class="text-muted pull-right">
                                            <small class="text-muted"><%= comment.date.toLocaleDateString() %></small>
                                        </span>
                                        <strong class="text-success"><%= comment.author[0].username %></strong>
                                        <p><%= comment.text %></p>
                                    <% }); %>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>      
    </div>
</div>

<%- include("partials/footer") %>